<!doctype html>
<html class="scroll">
<head>
    <!-- Basic -->
    <meta charset="UTF-8">
    <!-- Vendor CSS -->
    <link rel="stylesheet" href="assets/vendor/bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="assets/vendor/font-awesome/css/font-awesome.css" />
    <link rel="stylesheet" href="assets/vendor/magnific-popup/magnific-popup.css" />
    <link rel="stylesheet" href="assets/vendor/bootstrap-datepicker/css/datepicker3.css" />
    <!-- Theme CSS -->
    <link rel="stylesheet" href="assets/stylesheets/theme.css" />
    <!-- Skin CSS -->
    <link rel="stylesheet" href="assets/stylesheets/skins/default.css" />
    <!-- Theme Custom CSS -->
    <link rel="stylesheet" href="assets/stylesheets/theme-custom.css">
    <!-- Head Libs -->
    <script src="assets/vendor/modernizr/modernizr.js"></script>
    <script type="text/javascript" src="../lib/ckeditor/ckeditor.js" ></script>

    <!--self-->
    <link rel="stylesheet" href="../web2/css/common.css">
    <script type="text/javascript" src="../web2/analyse/analyse-common.js" ></script>
    <script type="text/javascript" src="../web2/component/component-btn.js" ></script>
    <script type="text/javascript" src="../web2/component/component-form.js" ></script>
    <script type="text/javascript" src="../web2/component/component-toast.js" ></script>
    <script type="text/javascript" src="../web2/component/component-pop.js" ></script>
    <script type="text/javascript" src="assets/url.js" ></script>

    <!--ztree-->
    <link rel="stylesheet" href="../lib/ztree3/css/metroStyle/metroStyle.css" type="text/css">
    <script type="text/javascript" src="../lib/ztree3/js/jquery-1.4.4.min.js"></script>
    <script type="text/javascript" src="../lib/ztree3/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="../lib/ztree3/js/jquery.ztree.excheck.js"></script>
    <script type="text/javascript" src="../lib/ztree3/js/jquery.ztree.exedit.js"></script>
    <script type="text/javascript" src="../lib/ztree3/tree-common.js"></script>
</head>
<body>

    <!-- start: page -->
    <div class="row">
        <div class="col-lg-12">
            <section class="panel">
                <table-oper>
                    <div class="input-group input-search" style="width: 200px;">
                        <button id="add" color="orange" style="margin-right: 5px;">新增</button>
                        <button id="upd" color="blue" style="margin-right: 5px;">编辑</button>
                        <button id="del" color="red">删除</button>
                    </div>
                </table-oper>
                <div class="zTreeDemoBackground">
                    <ul id="dicTree" class="ztree"></ul>
                </div>
            </section>
        </div>
    </div>
    <!-- end: page -->

    <lay pop>
        <pop id="pop">
            <div class="pop-dash" style="width: 500px;">
                <form id="form">
                    <input type="hidden" id="dicId" name="dicId" />
                    <div class="form-group">
                        <label class="col-md-3 control-label" >字典名称</label>
                        <div class="col-md-8">
                            <input type="text" name="dicName" msg="请输入数据字典名称" check="has" class="form-control" >
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label" >字典值</label>
                        <div class="col-md-8">
                            <input type="text" name="dicCode" msg="请输入数据字典值" check="has" class="form-control" >
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label" >父节点</label>
                        <div class="col-md-4">
                            <div class="zTreeDemoBackground">
                                <ul id="dicTree2" class="ztree"></ul>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-md-3 control-label" >描述信息</label>
                        <div class="col-md-8">
                            <textarea name="info" rows="4" class="form-control" ></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-md-6 col-xs-11">
                            <a id="save" class="btn btn-sm btn-primary" data-plugin-colorpicker data-color-format="hex" data-color="rgb(255, 255, 255)">保存</a>
                        </div>
                    </div>
                </form>
            </div>
        </pop>
    </lay>

    <!-- Vendor -->
    <!--<script src="assets/vendor/jquery/jquery.js"></script>-->
    <script src="assets/vendor/jquery-browser-mobile/jquery.browser.mobile.js"></script>
    <script src="assets/vendor/nanoscroller/nanoscroller.js"></script>
    <script src="assets/vendor/magnific-popup/magnific-popup.js"></script>
    <script src="assets/vendor/jquery-placeholder/jquery.placeholder.js"></script>

    <!-- Specific Page Vendor -->
    <!-- Theme Base, Components and Settings -->
    <!-- Theme Custom -->
    <script src="assets/javascripts/theme.custom.js"></script>
    <!-- Theme Initialization Files -->
    <script src="assets/javascripts/theme.init.js"></script>
    <script>
        var tree2,tree1;
        $(document).ready(function(){
            tree1=$.fn.zTree.init($("#dicTree"), defaultSetting(dicUrl+"getTree"));
        });

        popComponent("pop",9999,"数据字典");
        $("#add").click(function () {
            formDataClean("form");
            tree2=$.fn.zTree.init($("#dicTree2"), radioSetting(dicUrl+"getTree"));
            popShow("pop");
        });

        $("#upd").click(function () {
            formDataClean("form");
            if(!getSelectNode(tree1)){
                toastShow("请选择一个节点");
                return ;
            }
            post(dicUrl+"queryById/"+getSelectNodeId(tree1),null,function (res) {
               if(res.code=='OK'){
                   var setting=radioSetting(dicUrl+"getTree");
                   setting.radioId=res.model.parentId;
                   tree2=$.fn.zTree.init($("#dicTree2"), setting);
                   popShow("pop");
                   formDataBind("form",res.model);
               }
            });
        });

        $("#del").click(function () {
            var id=getSelectNodeId(tree1);
            if(isEmpty(id)){
                toastShow("请选择一个节点");
                return ;
            }
            post(dicUrl+"data/del",{"dicId":id},function (res) {
                if(res.code=='OK'){
                    tree1.removeNode(getSelectNode(tree1));
                    toastShow("删除成功");
                }else{
                    toastShow("删除失败:"+res.message);
                }
            });
        });

        formComponent("form");
        $("#save").click(function () {
            var map=formDataMap("form");
            var c=formCheckSubmit("form");
            if(c!=true){
                toastShow(c);
                return ;
            }
            var id=getCheckNodeId(tree2);
            if(!isEmpty(id)){
                map.parentId=id;
            }else{
                map.parentId="";
            }
            if(isEmpty(map.dicId)){
                post(dicUrl+"data/add",map,function (res) {
                    if(res.code=='OK'){
                        reAsyncNode(tree1,id);
                        popShow("pop",false);
                    }else{
                        toastShow("保存失败:"+res.message);
                    }
                });
            }else{
                if(map.parentId==map.dicId){
                    toastShow("父节点不能选择自己");
                    return ;
                }
                post(dicUrl+"data/upd",map,function (res) {
                    if(res.code=='OK'){
                        editSelectedName(tree1,res.model.dicName,res.model.parentId);
                        popShow("pop",false);
                    }else{
                        toastShow("保存失败:"+res.message);
                    }
                });
            }

        });


        btnComponent();
    </script>
</section>
</body>
</html>